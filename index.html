<!DOCTYPE html>
<head title="Text to Image to Speech">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap-combined.min.css"
    rel="stylesheet">
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.1/jquery.fancybox.css"
    type="text/css" media="screen" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <style type="text/css">
        img {
            max-height: 200px;
            max-width: 200px;
            min-height: 200px;
            min-width: 200px;
        }
    </style>
</head>
<body>
	<div class="container">
		<textarea id="pikd_input" rows="3" class="input-block-level" placeholder="Type text here to pik it!"></textarea>
		<button id="pikd_submit" class="btn btn-success input-block-level" type="button">Go!</button>
	</div>
	<div class="container">
	    <div class="row-fluid">
	        <div id="galleria"></div>
	    </div>
	</div>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
    <script type="text/javascript" src="galleria-1.2.8.min.js"></script>
    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.1/jquery.fancybox.pack.js"></script>
    <script type="text/javascript" src="speakGenerator.js"></script>
    <script type="text/javascript" src="speakClient.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            function getUrlVar(key){
                var result = new RegExp(key + "=([^&]*)", "i").exec(window.location.search); 
                return result && result[1] || ""; 
            }
			var my_func = function (i) {
				return function(data) {
    				$.each(data.result, function(k,v){
                        if (v !== null && v.length !==0 && v[1] !== null && v[1].length !==0){           
        					$("#cat"+i).append('<a rel="gallery" class="fancybox" href="'+v[1][0][0]+'" alt="'+v[0]+'"><img src="'+v[1][0][1]+'" data-title="'+v[0]+'" alt="'+v[0]+'"></a>');
                        }
                        else {
                            console.log(i, v);
                        }
    				});
				};
			};
        	$("#pikd_submit").click(function(){
                var substrings =$("#pikd_input").val().replace(/[^A-z0-9 \n\t\r,!:;\?.]/g,"").split(/(?:[.\?!,:;\n\t\r-][ \n\t\r])/); 
        		$("#galleria").empty();
                console.log(substrings);
        		for (var a =0; a< substrings.length; a++){
                    if (substrings[a] != ""){
            			$("#galleria").append('<span id="cat'+a+'"></span>');
                        if (window.location.hostname === "localhost"){
                            if (getUrlVar("nsfw")!==""){
                                $.getJSON("http://localhost:8000/full-api-unfiltered/?query="+encodeURIComponent(substrings[a].trim())+"&callback=?", my_func(a));
                            }
                            else{
                                $.getJSON("http://localhost:8000/full-api/?query="+encodeURIComponent(substrings[a].trim())+"&callback=?", my_func(a));
                            }
                        }
                        else {
                            if (getUrlVar("nsfw")!==""){
                                $.getJSON("http://larg"+Math.floor(Math.random()*10)+".herokuapp.com/full-api-unfiltered/?query="+encodeURIComponent(substrings[a].trim())+"&callback=?", my_func(a));
                            }
                            else{
                                $.getJSON("http://larg"+Math.floor(Math.random()*10)+".herokuapp.com/full-api/?query="+encodeURIComponent(substrings[a].trim())+"&callback=?", my_func(a));
                            }
                        }
                    }
        		}
        		// console.log(substrings);
        		return false;
        	});
    	    Galleria.loadTheme('/themes/classic/galleria.classic.min.js');
    		Galleria.run('#galleria');
    	    Galleria.configure({
			    "imageCrop": true,
			    "transition": 'fade'
			});
    	    if (Galleria) { console.log("Galleria works!!!");}
            $(".fancybox").fancybox({
                "openEffect": "none",
                "closeEffect": "none",
                "beforeLoad": function () {
                    this.title = $(this.element).find("img").attr("alt");
                },
                "helpers": {
                    title: {
                        type: "outside"
                    }
                },
                "afterLoad": function (current, previous) {
                    // console.info(current.title);
                    speak(current.title);
                }
            });
        });
    </script>
    <div id="audio"></div>
</body>
</html>